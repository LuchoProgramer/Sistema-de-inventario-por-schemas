{% extends 'base.html' %}

{% block title %}Registrar Conteo Diario{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center">Registrar Conteo Diario</h2>

    <form id="conteo-form" method="post">
        {% csrf_token %}

        <!-- Sucursal Activa (solo informativo) -->
        <div class="form-group">
            <label for="sucursal">Sucursal:</label>
            <input type="text" name="sucursal" class="form-control" value="{{ sucursal_activa.nombre }}" readonly>
        </div>

        <!-- Filtrar Productos por Categoría y Búsqueda -->
        <div class="form-row mt-4">
            <div class="form-group col-md-6">
                <label for="categoria-select">Filtrar por Categoría:</label>
                <select id="categoria-select" name="categoria" class="form-control">
                    <option value="">Todas las Categorías</option>
                    {% for categoria in categorias %}
                        <option value="{{ categoria.id }}" {% if categoria.id|stringformat:"s" == categoria_seleccionada %}selected{% endif %}>
                            {{ categoria.nombre }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group col-md-6">
                <label for="buscar-producto">Buscar Producto:</label>
                <input type="text" id="buscar-producto" class="form-control" placeholder="Ingrese el nombre del producto">
            </div>
        </div>

        <!-- Listado de Productos -->
        <h3 class="mt-4">Productos:</h3>
        <div id="productos-list" class="mt-3">
            {% for item in productos_con_campos %}
                <div class="product-item" data-categoria="{{ item.producto.categoria_id }}" data-nombre="{{ item.producto.nombre|lower }}">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="form-check form-switch">
                                <input 
                                    type="checkbox" 
                                    class="form-check-input producto-checkbox" 
                                    id="{{ item.producto_field.id_for_label }}" 
                                    name="{{ item.producto_field.html_name }}"
                                    value="on"  
                                    {% if item.producto_field.value %} checked {% endif %}  
                                />
                                <label for="{{ item.producto_field.id_for_label }}" class="form-check-label">
                                    {{ item.producto.nombre }}
                                </label>
                            </div>
                            
                            <div class="form-group mt-2 cantidad-group">
                                <label for="{{ item.cantidad_field.id_for_label }}">Cantidad Contada:</label>
                                {{ item.cantidad_field }}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <button type="submit" class="btn btn-primary mt-4">Guardar Conteo</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include jQuery from CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Filtrar productos según la categoría seleccionada
        $('#categoria-select').change(function() {
            filtrarProductos();
        });

        // Filtrar productos según la búsqueda
        $('#buscar-producto').on('input', function() {
            filtrarProductos();
        });

        function filtrarProductos() {
            var categoriaId = $('#categoria-select').val();
            var textoBusqueda = $('#buscar-producto').val().toLowerCase();

            $('.product-item').each(function() {
                var categoriaProducto = $(this).data('categoria').toString();
                var nombreProducto = $(this).data('nombre');

                var coincideCategoria = categoriaId === "" || categoriaProducto === categoriaId;
                var coincideBusqueda = nombreProducto.includes(textoBusqueda);

                if (coincideCategoria && coincideBusqueda) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }

        // Validación en tiempo real de cantidad
        $('.cantidad-group input').on('input', function() {
            var cantidad = $(this).val();
            if (cantidad <= 0 || cantidad === '') {
                $(this).addClass('is-invalid');
            } else {
                $(this).removeClass('is-invalid');
            }
        });

        // Validar formulario antes de enviar
        $('#conteo-form').on('submit', function(event) {
            var isValid = true;

            $('.product-item:visible').each(function() {
                var checkbox = $(this).find('input.producto-checkbox');
                var cantidadInput = $(this).find('.cantidad-group input');

                if (!checkbox.is(':checked')) {
                    isValid = false;
                    checkbox.closest('.card').addClass('border-danger');
                } else {
                    checkbox.closest('.card').removeClass('border-danger');
                }

                if (cantidadInput.val() <= 0 || cantidadInput.val() === '') {
                    isValid = false;
                    cantidadInput.addClass('is-invalid');
                } else {
                    cantidadInput.removeClass('is-invalid');
                }
            });

            if (!isValid) {
                event.preventDefault();
                alert('Por favor, completa todos los campos obligatorios antes de continuar.');
            }
        });

        // Marcar o desmarcar cantidad según el checkbox
        $('.producto-checkbox').change(function() {
            var cantidadInput = $(this).closest('.card-body').find('.cantidad-group input');
            if ($(this).is(':checked')) {
                cantidadInput.prop('disabled', false);
            } else {
                cantidadInput.prop('disabled', true).val('');
            }
        }).trigger('change'); // Inicializar estado al cargar la página
    });
</script>

<style>
    .is-invalid {
        border-color: #dc3545;
    }
    .border-danger {
        border-color: #dc3545 !important;
    }
    .card {
        border: 1px solid #ced4da;
    }
    .card-body {
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
    .cantidad-group {
        width: 200px;
    }
    @media (max-width: 576px) {
        .card-body {
            flex-direction: column;
            align-items: flex-start;
        }
        .cantidad-group {
            width: 100%;
            margin-top: 10px;
        }
    }
</style>
{% endblock %}
