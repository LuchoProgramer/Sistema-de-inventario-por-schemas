{% extends 'base.html' %}

{% block title %}Registrar Conteo{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center">Registrar Conteo de Productos en {{ turno.sucursal.nombre }}</h1>

    <!-- Filtro de categoría -->
    <div class="row align-items-center mt-3">
        <div class="col-md-6">
            <label for="categoria-select">Filtrar por Categoría:</label>
            <select id="categoria-select" name="categoria" class="form-control">
                <option value="">Todas las Categorías</option>
                {% for categoria in categorias %}
                    <option value="{{ categoria.id }}" {% if categoria.id == categoria_seleccionada %}selected{% endif %}>
                        {{ categoria.nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label for="buscar-producto">Buscar Producto:</label>
            <input type="text" id="buscar-producto" class="form-control" placeholder="Ingrese el nombre del producto">
        </div>
    </div>

    <!-- Formulario para registrar el conteo -->
    <form method="POST" class="mt-4">
        {% csrf_token %}
        
        <!-- Lista de productos para contar -->
        <div id="productos-container" class="row row-cols-1 g-4 mt-3">
            {% for producto_campo in productos_con_campos %}
            <div class="col producto-item" 
                 data-categoria="{{ producto_campo.producto.categoria.id }}" 
                 data-nombre="{{ producto_campo.producto.nombre|lower }}">
                <div class="card w-100">
                    <div class="card-body">
                        <h5 class="card-title">{{ producto_campo.producto.nombre }}</h5>

                        <!-- Campo de entrada para la cantidad contada -->
                        <div class="mb-3">
                            <label for="{{ producto_campo.producto_field.id_for_label }}" class="form-label">
                                Cantidad Contada
                            </label>
                            {{ producto_campo.cantidad_field }}
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <p>No hay productos disponibles para esta sucursal.</p>
            {% endfor %}
        </div>

        <!-- Botón para enviar el formulario -->
        <button type="submit" class="btn btn-success mt-3">Registrar Conteo</button>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<!-- Include jQuery from CDN -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function() {
        // Filtrar productos según la categoría seleccionada
        $('#categoria-select').change(function() {
            filtrarProductos();
        });

        // Filtrar productos según la búsqueda en vivo
        $('#buscar-producto').on('input', function() {
            filtrarProductos();
        });

        function filtrarProductos() {
            var categoriaId = $('#categoria-select').val();
            var textoBusqueda = $('#buscar-producto').val().toLowerCase();

            $('.producto-item').each(function() {
                var categoriaProducto = $(this).data('categoria').toString();
                var nombreProducto = $(this).data('nombre');

                var coincideCategoria = categoriaId === "" || categoriaProducto === categoriaId;
                var coincideBusqueda = nombreProducto.includes(textoBusqueda);

                if (coincideCategoria && coincideBusqueda) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        }
    });
</script>

<style>
    .card {
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
    }

    .producto-item {
        display: flex;
        align-items: center;
    }

    .btn-success {
        width: 100%;
        padding: 15px;
        font-size: 16px;
    }
</style>
{% endblock %}
