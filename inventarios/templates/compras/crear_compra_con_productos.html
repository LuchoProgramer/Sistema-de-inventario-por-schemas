{% extends 'base_administrador.html' %}

{% block content %}
    <div class="container mt-5">
        <h1 class="mb-4">Crear Compra</h1>

        <form method="post" id="compra-form">
            {% csrf_token %}
            {{ compra_form.as_p }}  <!-- Renderizamos los campos de la compra -->
            {{ formset.management_form }}  <!-- Incluimos el management form -->

            <table id="productos-table" class="table table-striped mt-4">
                <thead class="table-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                    </tr>
                </thead>
                <tbody id="productos-rows">
                    {% for form in formset %}
                    <tr class="producto-form">
                        <td>{{ form.producto }}</td>
                        <td>{{ form.cantidad }}</td>
                        <td>{{ form.precio_unitario }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <button type="button" id="add-more-products" class="btn btn-secondary mt-3">Añadir más productos</button>
            <button type="submit" id="submit-compra" class="btn btn-primary mt-3">Guardar Compra</button>
        </form>

        <a href="{% url 'compras:lista_compras' %}" class="btn btn-link mt-4">Volver a la lista de compras</a>
    </div>

    <!-- Script para agregar dinámicamente más filas de productos -->
    {% block extra_js %}
    <script>
        document.getElementById('add-more-products').addEventListener('click', function() {
            // Obtener el conteo actual de formularios desde el management_form
            const formCount = parseInt(document.getElementById('id_detalles-TOTAL_FORMS').value);
            // Clonar la última fila del formulario
            const newForm = document.querySelector('.producto-form:last-of-type').cloneNode(true);
            
            // Actualizar los nombres y IDs de los inputs
            newForm.querySelectorAll('input, select, textarea').forEach(input => {
                const name = input.getAttribute('name');
                const id = input.getAttribute('id');
                if (name) {
                    // Reemplazar el número en el nombre
                    const newName = name.replace(/detalles-(\d+)-/, `detalles-${formCount}-`);
                    input.setAttribute('name', newName);
                }
                if (id) {
                    // Reemplazar el número en el id
                    const newId = id.replace(/id_detalles-(\d+)-/, `id_detalles-${formCount}-`);
                    input.setAttribute('id', newId);
                }
                // Limpiar el valor si no es un campo oculto
                if (input.type !== 'hidden') {
                    input.value = '';
                }
            });

            // Agregar el nuevo formulario al DOM
            document.querySelector('#productos-table tbody').appendChild(newForm);

            // Incrementar TOTAL_FORMS en el management_form
            document.getElementById('id_detalles-TOTAL_FORMS').value = formCount + 1;
        });
    </script>
    {% endblock %}
{% endblock %}