{% extends 'base_administrador.html' %}

{% block content %}
    <div class="container mt-5">
        <h1 class="mb-4">Crear Compra</h1>

        <form method="post" id="compra-form">
            {% csrf_token %}
            {{ compra_form.as_p }}
            {{ formset.management_form }}

            <table id="productos-table" class="table table-striped mt-4">
                <thead class="table-dark">
                    <tr>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario (sin Impuesto)</th>
                        <th>Precio Unitario (con Impuesto)</th>
                    </tr>
                </thead>
                <tbody id="productos-rows">
                    {% for form in formset %}
                    <tr class="producto-form">
                        <td>{{ form.producto }}</td>
                        <td>{{ form.cantidad }}</td>
                        <td>{{ form.precio_unitario }}</td>
                        <td>
                            <input type="text" class="form-control" id="precio-con-impuesto-{{ forloop.counter }}" readonly>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <button type="button" id="add-more-products" class="btn btn-secondary mt-3">Añadir más productos</button>
            <button type="submit" id="submit-compra" class="btn btn-primary mt-3">Guardar Compra</button>
        </form>

        <a href="{% url 'compras:lista_compras' %}" class="btn btn-link mt-4">Volver a la lista de compras</a>
    </div>

    {% block extra_js %}
    <script>
        // Asignar el porcentaje de impuesto desde una variable de Django a una variable global de JS
        var impuestoPorcentaje = parseFloat("{{ impuesto_activo.porcentaje|default:0 }}");

        document.getElementById('add-more-products').addEventListener('click', function() {
            const formCount = parseInt(document.getElementById('id_detalles-TOTAL_FORMS').value);
            const newForm = document.querySelector('.producto-form:last-of-type').cloneNode(true);

            newForm.querySelectorAll('input, select, textarea').forEach(input => {
                const name = input.getAttribute('name');
                const id = input.getAttribute('id');
                if (name) {
                    const newName = name.replace(/detalles-(\d+)-/, `detalles-${formCount}-`);
                    input.setAttribute('name', newName);
                }
                if (id) {
                    const newId = id.replace(/id_detalles-(\d+)-/, `id_detalles-${formCount}-`);
                    input.setAttribute('id', newId);
                }
                if (input.type !== 'hidden') {
                    input.value = '';
                }
            });

            document.querySelector('#productos-table tbody').appendChild(newForm);
            document.getElementById('id_detalles-TOTAL_FORMS').value = formCount + 1;
        });

        // Calcular el precio con impuesto en tiempo real
        document.querySelectorAll('input[name$="precio_unitario"]').forEach((input, index) => {
            input.addEventListener('input', function() {
                const precioSinImpuesto = parseFloat(this.value) || 0;
                const precioConImpuesto = precioSinImpuesto + (precioSinImpuesto * (impuestoPorcentaje / 100));
                
                document.getElementById(`precio-con-impuesto-${index + 1}`).value = precioConImpuesto.toFixed(2);
            });
        });
    </script>
    {% endblock %}
{% endblock %}
